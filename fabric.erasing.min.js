import{fabric as t}from"fabric";!function(){t.Object.ENLIVEN_PROPS.push("eraser");let e=t.Object.prototype._drawClipPath,a=t.Object.prototype.needsItsOwnCache,r=t.Object.prototype.toObject;t.Object.prototype.getSvgCommons,t.Object.prototype._createBaseClipPathSVGMarkup,t.Object.prototype._createBaseSVGMarkup,t.Object.prototype.cacheProperties.push("eraser"),t.Object.prototype.stateProperties.push("eraser"),t.util.object.extend(t.Object.prototype,{erasable:!0,eraser:void 0,needsItsOwnCache:function(){return a.call(this)||!!this.eraser},_drawClipPath:function(t,a){if(e.call(this,t,a),this.eraser){let r=this._getNonTransformedDimensions();this.eraser.isType("eraser")&&this.eraser.set({width:r.x,height:r.y}),e.call(this,t,this.eraser)}},toObject:function(t){let e=r.call(this,["erasable"].concat(t));return this.eraser&&!this.eraser.excludeFromExport&&(e.eraser=this.eraser.toObject(t)),e}});let s=t.Group.prototype._restoreObjectsState;t.util.object.extend(t.Group.prototype,{_addEraserPathToObjects:function(e){this._objects.forEach(function(a){t.EraserBrush.prototype._addPathToObjectEraser.call(t.EraserBrush.prototype,a,e)})},applyEraserToObjects:function(){let e=this,a=this.eraser;if(a){delete this.eraser;let r=e.calcTransformMatrix();a.clone(function(a){let s=e.clipPath;a.getObjects("path").forEach(function(a){let i=t.util.multiplyTransformMatrices(r,a.calcTransformMatrix());t.util.applyTransformToObject(a,i),s?s.clone(function(s){let i=t.EraserBrush.prototype.applyClipPathToPath.call(t.EraserBrush.prototype,a,s,r);e._addEraserPathToObjects(i)},["absolutePositioned","inverted"]):e._addEraserPathToObjects(a)})})}},_restoreObjectsState:function(){return!0===this.erasable&&this.applyEraserToObjects(),s.call(this)}}),t.Eraser=t.util.createClass(t.Group,{type:"eraser",originX:"center",originY:"center",drawObject:function(t){t.save(),t.fillStyle="black",t.fillRect(-this.width/2,-this.height/2,this.width,this.height),t.restore(),this.callSuper("drawObject",t)},_getBounds:function(){}}),t.Eraser.fromObject=function(e,a){let r=e.objects;t.util.enlivenObjects(r,function(r){let s=t.util.object.clone(e,!0);delete s.objects,t.util.enlivenObjectEnlivables(e,s,function(){a&&a(new t.Eraser(r,s,!0))})})};let i=t.Canvas.prototype._renderOverlay;t.util.object.extend(t.Canvas.prototype,{isErasing:function(){return this.isDrawingMode&&this.freeDrawingBrush&&"eraser"===this.freeDrawingBrush.type&&this.freeDrawingBrush._isErasing},_renderOverlay:function(t){i.call(this,t),this.isErasing()&&!this.freeDrawingBrush.inverted&&this.freeDrawingBrush._render()}}),t.EraserBrush=t.util.createClass(t.PencilBrush,{type:"eraser",inverted:!1,_isErasing:!1,_isErasable:function(t){return!1!==t.erasable},_prepareCollectionTraversal:function(t,e,a){t.forEachObject(function(r){r.forEachObject&&"deep"===r.erasable?this._prepareCollectionTraversal(r,e,a):!this.inverted&&r.erasable&&r.visible?(r.visible=!1,t.dirty=!0,a.visibility.push(r),a.collection.push(t)):this.inverted&&r.visible&&(r.erasable&&r.eraser?(r.eraser.inverted=!0,r.dirty=!0,t.dirty=!0,a.eraser.push(r),a.collection.push(t)):(r.visible=!1,t.dirty=!0,a.visibility.push(r),a.collection.push(t)))},this)},preparePattern:function(){this._patternCanvas||(this._patternCanvas=t.util.createCanvasElement());let e=this._patternCanvas;e.width=this.canvas.width,e.height=this.canvas.height;let a=e.getContext("2d");if(this.canvas._isRetinaScaling()){let r=this.canvas.getRetinaScaling();this.canvas.__initRetinaScaling(r,e,a)}let s=this.canvas.backgroundImage,n=s&&this._isErasable(s),o=this.canvas.overlayImage,c=o&&this._isErasable(o);if(!this.inverted&&(s&&!n||this.canvas.backgroundColor))n&&(this.canvas.backgroundImage=void 0),this.canvas._renderBackground(a),n&&(this.canvas.backgroundImage=s);else if(this.inverted&&s&&n){var l=this.canvas.backgroundColor;this.canvas.backgroundColor=void 0,this.canvas._renderBackground(a),this.canvas.backgroundColor=l}a.save(),a.transform.apply(a,this.canvas.viewportTransform);let h={visibility:[],eraser:[],collection:[]};if(this._prepareCollectionTraversal(this.canvas,a,h),this.canvas._renderObjects(a,this.canvas._objects),h.visibility.forEach(function(t){t.visible=!0}),h.eraser.forEach(function(t){t.eraser.inverted=!1,t.dirty=!0}),h.collection.forEach(function(t){t.dirty=!0}),a.restore(),!this.inverted&&(o&&!c||this.canvas.overlayColor))c&&(this.canvas.overlayImage=void 0),i.call(this.canvas,a),c&&(this.canvas.overlayImage=o);else if(this.inverted&&o&&c){var l=this.canvas.overlayColor;this.canvas.overlayColor=void 0,i.call(this.canvas,a),this.canvas.overlayColor=l}},_setBrushStyles:function(t){this.callSuper("_setBrushStyles",t),t.strokeStyle="black"},_saveAndTransform:function(t){this.callSuper("_saveAndTransform",t),this._setBrushStyles(t),t.globalCompositeOperation=t===this.canvas.getContext()?"destination-out":"source-over"},needsFullRender:function(){return!0},onMouseDown:function(t,e){this.canvas._isMainEvent(e.e)&&(this._prepareForDrawing(t),this._captureDrawingPath(t),this.preparePattern(),this._isErasing=!0,this.canvas.fire("erasing:start"),this._render())},_render:function(){let t;this.inverted||(t=this.canvas.getContext(),this.callSuper("_render",t)),t=this.canvas.contextTop,this.canvas.clearContext(t),this.callSuper("_render",t),t.save();let e=1/this.canvas.getRetinaScaling();t.scale(e,e),t.globalCompositeOperation="source-in",t.drawImage(this._patternCanvas,0,0),t.restore()},createPath:function(t){let e=this.callSuper("createPath",t);return e.globalCompositeOperation=this.inverted?"source-over":"destination-out",e.stroke=this.inverted?"white":"black",e},applyClipPathToPath:function(e,a,r){let s=t.util.invertTransform(e.calcTransformMatrix()),i=a.calcTransformMatrix(),n=a.absolutePositioned?s:t.util.multiplyTransformMatrices(s,r);return a.absolutePositioned=!1,t.util.applyTransformToObject(a,t.util.multiplyTransformMatrices(n,i)),e.clipPath=e.clipPath?t.util.mergeClipPaths(a,e.clipPath):a,e},clonePathWithClipPath:function(t,e,a){let r=e.calcTransformMatrix(),s=e.clipPath,i=this;t.clone(function(t){s.clone(function(e){a(i.applyClipPathToPath(t,e,r))},["absolutePositioned","inverted"])})},_addPathToObjectEraser:function(e,a){let r=this;if(e.forEachObject&&"deep"===e.erasable){let s=e._objects.filter(function(t){return t.erasable});s.length>0&&e.clipPath?this.clonePathWithClipPath(a,e,function(t){s.forEach(function(e){r._addPathToObjectEraser(e,t)})}):s.length>0&&s.forEach(function(t){r._addPathToObjectEraser(t,a)});return}let i=e.eraser;i||(i=new t.Eraser,e.eraser=i),a.clone(function(a){let s=t.util.multiplyTransformMatrices(t.util.invertTransform(e.calcTransformMatrix()),a.calcTransformMatrix());t.util.applyTransformToObject(a,s),i.addWithUpdate(a),e.set("dirty",!0),e.fire("erasing:end",{path:a}),e.group&&Array.isArray(r.__subTargets)&&r.__subTargets.push(e)})},applyEraserToCanvas:function(t){let e=this.canvas,a={};return["backgroundImage","overlayImage"].forEach(function(r){let s=e[r];s&&s.erasable&&(this._addPathToObjectEraser(s,t),a[r]=s)},this),a},_finalizeAndAddPath:function(){let t=this.canvas.contextTop,e=this.canvas;t.closePath(),this.decimate&&(this._points=this.decimatePoints(this._points,this.decimate)),e.clearContext(e.contextTop),this._isErasing=!1;let a=this._points&&this._points.length>1?this.convertPointsToSVGPath(this._points):null;if(!a||this._isEmptySVGPath(a)){e.fire("erasing:end"),e.requestRenderAll();return}let r=this.createPath(a);r.setCoords(),e.fire("before:path:created",{path:r});let s=this.applyEraserToCanvas(r),i=this;this.__subTargets=[];let n=[];e.forEachObject(function(t){t.erasable&&t.intersectsWithObject(r,!0,!0)&&(i._addPathToObjectEraser(t,r),n.push(t))}),e.fire("erasing:end",{path:r,targets:n,subTargets:this.__subTargets,drawables:s}),delete this.__subTargets,e.requestRenderAll(),this._resetShadow(),e.fire("path:created",{path:r})}})}();